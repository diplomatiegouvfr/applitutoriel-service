<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="produit">

    <resultMap type="fr.gouv.diplomatie.applitutoriel.business.bo.Produit" id="mapProduit">
        <result column="ID_PRODUIT" property="id" />
        <result column="PRO_NOM" property="nom" />
        <result column="PRO_DESCR" property="desc" />
        <association column="ID_SECTEUR" property="secteur" resultMap="secteur.mapSecteur" />
    </resultMap>
    
     <resultMap type="fr.gouv.diplomatie.applitutoriel.business.bo.Repartition" id="mapRepartition">
        <result column="SEC_NOM" property="nomSecteur" />
        <result column="nbProduits" property="nbProduits" />
    </resultMap>

    <select id="select" resultMap="mapProduit">
        SELECT PRODUIT.*, SECTEUR.*
        FROM PRODUIT
            INNER JOIN SECTEUR ON PRODUIT.ID_SECTEUR = SECTEUR.ID_SECTEUR
        ORDER BY PRO_NOM ASC;
    </select>
    
    <select id="selectByIdPartenaire" resultMap="mapProduit">
        SELECT PRODUIT.*, SECTEUR.*
        FROM PRODUIT
	        INNER JOIN SECTEUR ON PRODUIT.ID_SECTEUR = SECTEUR.ID_SECTEUR
	        INNER JOIN PRODUIT_PARTENAIRE ON PRODUIT_PARTENAIRE.ID_PRODUIT = PRODUIT.ID_PRODUIT
        WHERE PRODUIT_PARTENAIRE.ID_PARTENAIRE = #{idPartenaire}
        ORDER BY PRO_NOM ASC;
    </select>
    
    <insert id="insertProduitPartenaire">
        INSERT INTO PRODUIT_PARTENAIRE 
        (
            ID_PRODUIT, ID_PARTENAIRE
        ) 
        VALUES 
        (
            #{idProduit}, #{idPartenaire}
        );
    </insert>
    
    <delete id="deleteProduitPartenaire" parameterType="fr.gouv.diplomatie.applitutoriel.business.bo.Partenaire" >
        DELETE FROM PRODUIT_PARTENAIRE WHERE ID_PARTENAIRE = #{id}
    </delete>
    
    <sql id="getPercent">ROUND(COUNT(*) * 100 / (24))</sql>
    
    <select id="countProduitsBySecteur" resultMap="mapRepartition">
		SELECT SECTEUR.SEC_NOM, COUNT(*) as "nbProduits" 
		FROM PRODUIT INNER JOIN SECTEUR ON PRODUIT.ID_SECTEUR = SECTEUR.ID_SECTEUR GROUP BY SECTEUR.SEC_NOM;
    </select>
</mapper>